using AzRanger.Models;
using AzRanger.Models.ExchangeOnline;

namespace AzRanger.Checks.Rules
{
    [RuleInfo("EXONotifcationUsersSendingMalware", Scope.EXO, MaturityLevel.Mature, "https://security.microsoft.com/antimalwarev2")]
    [RuleScore("No one is notfied if a users sends potential malicious mails", "It is possible to alarm an administraotr if a users send malicious mails", 5, "https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/configure-anti-malware-policies?view=o365-worldwide")]
    class EXONotifcationUsersSendingMalware : BaseCheck
    {
        public override CheckResult Audit(Tenant tenant)
        {
            foreach(MalwareFilterPolicy policy in tenant.ExchangeOnlineSettings.MalwareFilterPolicy)
            {
                if(policy.EnableInternalSenderAdminNotifications == true && policy.InternalSenderAdminAddress.Length > 0)
                {
                    // If it is implemented in Default Policy => Good because we cannot disable it
                    if (policy.Id.Equals("Default"))
                    {
                        return CheckResult.Passed;
                    }
                    else
                    {
                        // If it is not enabled in Default Policy, we need to check if FilterRule is enabled
                        foreach(MalwareFilterRule rule in tenant.ExchangeOnlineSettings.MalwareFilterRule)
                        {
                            if (policy.Identity.Equals(rule.Identity))
                            {
                                if (rule.State.Equals("Enabled"))
                                {
                                    return CheckResult.Passed;
                                }
                            }
                        }
                    }
                }
            }
            return CheckResult.Failed;
        }
    }
}
